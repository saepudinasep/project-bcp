<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cek Result Biro Kredit | WOM Finance</title>
    <link rel="icon" href="wom-finance.jpg" type="image/png" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
      // Menonaktifkan Klik Kanan
      document.addEventListener("contextmenu", function (e) {
        e.preventDefault();
      });

      // Menonaktifkan F12 dan Inspect Element
      document.addEventListener("keydown", function (e) {
        if (e.key === "F12" || (e.ctrlKey && e.shiftKey && e.key === "I")) {
          e.preventDefault();
        }
      });
    </script>
  </head>
  <body class="bg-light">
    <div class="container py-3">
      <h1 class="mb-4 text-center">Cek Biro Kredit - WOM Finance</h1>
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0 small">Silahkan Isi Form Dibawah Dengan Benar!</h5>
        </div>
        <div class="card-body">
          <h5 class="card-title">Request By</h5>
          <form id="faqForm" method="POST" novalidate>
            <!-- Brand and Region -->
            <div class="row mb-2">
              <div class="col-md-6">
                <label for="brand" class="form-label small text-muted"
                  >Brand</label
                >
                <span class="text-danger">*</span>
                <select
                  id="brand"
                  name="entry.1166807493"
                  class="form-select form-select-sm"
                  required
                >
                  <option value="">-- Pilih Brand --</option>
                  <option value="Reguler">Reguler</option>
                  <option value="MasKu">MasKu</option>
                  <option value="MotorKu">MotorKu</option>
                  <option value="MobilKu">MobilKu</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="region" class="form-label small text-muted"
                  >Region</label
                >
                <span class="text-danger">*</span>
                <select
                  id="region"
                  name="entry.68294757"
                  class="form-select form-select-sm"
                >
                  <option value="">-- Pilih Region --</option>
                  <!-- Region options will be added dynamically -->
                </select>
              </div>
            </div>

            <!-- Cabang and NIK -->
            <div class="row mb-2">
              <div class="col-md-6">
                <label for="cabang" class="form-label small text-muted"
                  >Cabang</label
                >
                <span class="text-danger">*</span>
                <select
                  id="cabang"
                  name="entry.1353966975"
                  class="form-select form-select-sm"
                >
                  <option value="">-- Pilih Cabang --</option>
                  <!-- Cabang options will be added dynamically -->
                </select>
              </div>
              <div class="col-md-6">
                <label for="nik" class="form-label small text-muted"
                  >NIK Karyawan</label
                >
                <span class="text-danger">*</span>
                <input
                  type="number"
                  id="nik"
                  name="entry.1930913014"
                  class="form-control form-control-sm"
                />
              </div>
            </div>

            <!-- Nama -->
            <div class="row mb-2">
              <div class="col-md-12">
                <label for="nama" class="form-label small text-muted"
                  >Nama</label
                >
                <span class="text-danger">*</span>
                <input
                  type="text"
                  id="nama"
                  name="entry.1740279433"
                  class="form-control form-control-sm"
                />
              </div>
            </div>
            <h5 class="card-title mt-4">Data Pemohon</h5>
            <!-- Nama Cust and NIK KTP -->
            <div class="row mb-4">
              <div class="col-md-6">
                <label for="nikC" class="form-label small text-muted"
                  >NIK KTP</label
                >
                <span class="text-danger">*</span>
                <input
                  type="number"
                  id="nikC"
                  name="entry.630044997"
                  class="form-control form-control-sm"
                />
              </div>
              <div class="col-md-6">
                <label for="NCust" class="form-label small text-muted"
                  >Nama Cust</label
                >
                <span class="text-danger">*</span>
                <input
                  type="text"
                  id="NCust"
                  name="entry.1127486352"
                  class="form-control form-control-sm"
                />
              </div>
            </div>

            <!-- Buttons -->
            <div class="mb-2">
              <button
                type="submit"
                id="submitButton"
                class="btn btn-primary btn-sm"
              >
                Submit
              </button>
              <button
                type="button"
                class="btn btn-secondary btn-sm"
                onclick="window.location.reload()"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="container py-3">
      <h1 class="mb-4 text-center">Cek Result Biro Kredit - WOM Finance</h1>
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0 small">Cari Berdasarkan NIK KTP</h5>
        </div>
        <div class="card-body">
          <form id="searchForm">
            <div class="row g-3">
              <div class="col-md-3">
                <label for="searchNIK" class="form-label">NIK KTP</label>
                <input
                  type="text"
                  id="searchNIK"
                  class="form-control"
                  placeholder="Cari NIK KTP"
                />
              </div>
            </div>
            <div class="mt-3 text-end">
              <button
                type="button"
                id="clearBtn"
                class="btn btn-secondary me-2"
              >
                Clear
              </button>
              <button type="button" id="searchBtn" class="btn btn-primary">
                Cari
              </button>
            </div>
          </form>

          <!-- Tabel untuk Menampilkan Hasil Pencarian -->
          <table class="table mt-3" id="resultTable">
            <thead>
              <tr>
                <th scope="col">No</th>
                <th scope="col">Nama Customer</th>
                <th scope="col">Result KBIJ</th>
              </tr>
            </thead>
            <tbody>
              <!-- Data hasil pencarian akan muncul disini -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <script>
      // Elements
      const regionSelect = document.getElementById("region");
      const cabangSelect = document.getElementById("cabang");

      // Fetch data from output.json
      fetch("output.json")
        .then((response) => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then((data) => {
          // Populate Region options dynamically
          const regions = [...new Set(data.map((item) => item.Region))];
          regions.forEach((region) => {
            const option = document.createElement("option");
            option.value = region;
            option.textContent = region;
            regionSelect.appendChild(option);
          });

          // Handle Region selection change
          regionSelect.addEventListener("change", function () {
            const selectedRegion = this.value;

            // Clear previous Cabang options
            cabangSelect.innerHTML =
              '<option value="">-- Pilih Cabang --</option>';

            // Filter Cabang options based on selected Region
            const filteredCabang = data.filter(
              (item) => item.Region === selectedRegion
            );
            filteredCabang.forEach((item) => {
              const option = document.createElement("option");
              option.value = item.Cabang;
              option.textContent = item.Cabang;
              cabangSelect.appendChild(option);
            });
          });
        })
        .catch((error) => {
          console.error("Error fetching JSON:", error);
        });

      // Event listener untuk validasi saat form disubmit
      document
        .getElementById("faqForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          // Ambil nilai dari setiap field
          const brand = document.getElementById("brand").value.trim();
          const region = document.getElementById("region").value.trim();
          const cabang = document.getElementById("cabang").value.trim();
          const nikKaryawan = document.getElementById("nik").value.trim();
          const nama = document.getElementById("nama").value.trim();
          const nikKTP = document.getElementById("nikC").value.trim();
          const namaCust = document.getElementById("NCust").value.trim();

          // Validasi kosong
          if (
            !brand ||
            !region ||
            !cabang ||
            !nikKaryawan ||
            !nama ||
            !nikKTP ||
            !namaCust
          ) {
            Swal.fire("Gagal!", "Semua field harus diisi.", "error");
            return;
          }

          // Validasi NIK KTP: harus 16 digit, tidak boleh negatif
          if (!/^\d{16}$/.test(nikKTP)) {
            Swal.fire(
              "Gagal!",
              "NIK KTP harus terdiri dari 16 digit dan tidak boleh negatif.",
              "error"
            );
            return;
          }

          // Validasi NIK Karyawan: minimal 8 digit dan maksimal 9 digit
          if (!/^\d{8,9}$/.test(nikKaryawan)) {
            Swal.fire(
              "Gagal!",
              "NIK Karyawan harus terdiri dari 8 hingga 9 digit.",
              "error"
            );
            return;
          }

          // Jika semua validasi lolos, kirim formulir
          const form = document.getElementById("faqForm");
          form.action =
            "https://docs.google.com/forms/d/e/1FAIpQLSerVaqsrIt7blOl3pinUvIVMT9v1UIjiPjpB9lGuPawyYRfqA/formResponse";
          form.method = "POST";
          // form.submit();
          // Menggunakan fetch untuk mengirim data ke Google Forms
          fetch(form.action, {
            method: "POST",
            body: new FormData(form),
            mode: "no-cors", // CORS tidak diperiksa
          })
            .then(() => {
              // Menunggu untuk pengiriman berhasil
              setTimeout(function () {
                Swal.fire("Berhasil!", "Formulir berhasil dikirim.", "success");
                form.reset(); // Reset formulir
                window.location.reload();
              }, 1000); // Waktu tunggu untuk simulasi
            })
            .catch(() => {
              // Jika gagal mengirim data
              Swal.fire("Gagal!", "Pengiriman formulir gagal.", "error");
            });
        });

      // Result Biro Kredit Disini
      // URL CSV dari Google Sheets
      const csvUrl =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vR75q5eXO_zUWB9i2AtFkSJzIqepYI7XSeTYVkGdlNRhk7bk4Htp9-4z5emU9lcP2w8-d35r6eBXSRB/pub?gid=1314586105&single=true&output=csv";

      let sheetData = []; // Array untuk menyimpan data CSV

      // Mengambil dan memproses data CSV
      fetch(csvUrl)
        .then((response) => response.text())
        .then((csvData) => {
          // Mengonversi CSV ke JSON
          const parsedData = Papa.parse(csvData, {
            header: true,
            skipEmptyLines: true,
          });
          sheetData = parsedData.data;
        })
        .catch((error) => {
          console.error("Error fetching CSV:", error);
        });

      // Fungsi untuk menampilkan hasil pencarian
      function displayResults(results) {
        const tbody = document.querySelector("#resultTable tbody");

        if (tbody) {
          tbody.innerHTML = ""; // Kosongkan tabel sebelum menampilkan data baru

          if (results.length > 0) {
            results.forEach((item, index) => {
              console.log(item);
              const row = document.createElement("tr");
              row.innerHTML = `
              <th scope="row">${index + 1}</th>
              <td>${item["Nama Customer"]}</td>
              <td>
                ${
                  ["NO", "no", "No", "nO"].includes(item["Result KBIJ"])
                    ? `${item["Result KBIJ"]}, Kol ${item["KOL"]}, Max DPD ${item["Max DPD"]}, Baki Debit ${item["Baki Debit"]}`
                    : item["Result KBIJ"]
                }
              </td>
            `;
              tbody.appendChild(row);
            });
          } else {
            const row = document.createElement("tr");
            row.innerHTML =
              "<td colspan='4' class='text-center'>Data tidak ditemukan</td>";
            tbody.appendChild(row);
          }
        } else {
          console.error("Tbody element not found!");
        }
      }

      // Menangani event klik tombol Cari
      document.getElementById("searchBtn").addEventListener("click", () => {
        const searchQuery = document.getElementById("searchNIK").value.trim();

        if (searchQuery) {
          // Mencari data yang sesuai dengan NIK KTP
          const results = sheetData.filter((item) =>
            item["NIK KTP"].includes(searchQuery)
          );
          displayResults(results);
        } else {
          alert("Mohon masukkan NIK KTP untuk pencarian.");
        }
      });

      // Menangani event klik tombol Clear
      document.getElementById("clearBtn").addEventListener("click", () => {
        document.getElementById("searchNIK").value = "";
        displayResults([]); // Menghapus hasil pencarian
      });
    </script>
  </body>
</html>
